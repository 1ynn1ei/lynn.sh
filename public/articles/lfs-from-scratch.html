<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="English" xml:lang="English">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body>
<div id="content" class="content">
<div id="outline-container-orgce665a5" class="outline-2">
<h2 id="orgce665a5">Installation</h2>
<div class="outline-text-2" id="text-orgce665a5">
</div>
<div id="outline-container-org91aad18" class="outline-3">
<h3 id="org91aad18">Partitioning</h3>
<div class="outline-text-3" id="text-org91aad18">
<p>
For partioning I referred to arch linux's excellent wiki, as well as the LFS hints page detailing the optimal partitioning of a desk.
Preferring to use GPT due to large disk size (m.2 drive of 1TiB) and future-proofing.
Using the Extended Boot Loader Partition type for my <code>/boot</code> partition, despite the LFS hint page saying they use ext2.
Splitting out root directory <code>/</code> (20GiB) and <code>/home</code> directory to keep the userspace separate from any LFS rebuilding.
</p>
</div>
</div>
<div id="outline-container-orgb4963ac" class="outline-3">
<h3 id="orgb4963ac">Formatting</h3>
<div class="outline-text-3" id="text-orgb4963ac">
</div>
<div id="outline-container-orgd7da9ae" class="outline-4">
<h4 id="orgd7da9ae">EFI System</h4>
<div class="outline-text-4" id="text-orgd7da9ae">
<p>
<code>mkfs.fat -F 32 /dev/nvme1n1p1</code> as GPT requires fat32
</p>
</div>
</div>
<div id="outline-container-org0bf8069" class="outline-4">
<h4 id="org0bf8069">/boot</h4>
<div class="outline-text-4" id="text-org0bf8069">
<p>
<code>mkfs -v -t ext2 /dev/nvme1n1p2</code> ext2, as we do not need the journaling feature of ext3 or ext4 for such a small partition.
</p>
</div>
</div>
<div id="outline-container-orgeec9beb" class="outline-4">
<h4 id="orgeec9beb">swap</h4>
<div class="outline-text-4" id="text-orgeec9beb">
<p>
<code>mkswap /dev/nvme1n1p3</code> super simple, just make swap.
</p>
</div>
</div>
<div id="outline-container-orga8b209c" class="outline-4">
<h4 id="orga8b209c">root</h4>
<div class="outline-text-4" id="text-orga8b209c">
<p>
<code>mkfs -v -t ext4 /dev/nvme1n1p4</code> ext4 as it is a major partition in the linux filesystem.
</p>
</div>
</div>
<div id="outline-container-orgb84ce6c" class="outline-4">
<h4 id="orgb84ce6c">/home</h4>
<div class="outline-text-4" id="text-orgb84ce6c">
<p>
<code>mkfs -v -t ext4 /dev/nvme1n1p5</code> same as root, this partition only exists to separate the root out from userspace.
</p>
</div>
</div>
</div>
<div id="outline-container-org8d4aaed" class="outline-3">
<h3 id="org8d4aaed">Mounting</h3>
<div class="outline-text-3" id="text-org8d4aaed">
<p>
Nothing major here, just need to remember to mount both <code>/</code> and <code>/home</code>, as well as swap using <code>/sbin/swapon -v /dev/nvme1n1p3</code>
</p>
</div>
</div>
<div id="outline-container-orgd46ee5e" class="outline-3">
<h3 id="orgd46ee5e">Cross-compile</h3>
<div class="outline-text-3" id="text-orgd46ee5e">
</div>
<div id="outline-container-orge7a8044" class="outline-4">
<h4 id="orge7a8044">binutils</h4>
<div class="outline-text-4" id="text-orge7a8044">
<p>
real <code>0m19.261s</code>
</p>
</div>
</div>
<div id="outline-container-org3bd6ba8" class="outline-4">
<h4 id="org3bd6ba8">gcc</h4>
<div class="outline-text-4" id="text-org3bd6ba8">
<p>
pass1: real <code>1m48.489s</code>
</p>

<p>
pass2: real <code>3m12.645s</code>
</p>
</div>
</div>
<div id="outline-container-orgfa51a65" class="outline-4">
<h4 id="orgfa51a65">glibc</h4>
<div class="outline-text-4" id="text-orgfa51a65">
<p>
real <code>0m37.319s</code>
</p>
</div>
</div>
<div id="outline-container-org150ce99" class="outline-4">
<h4 id="org150ce99">ncurses</h4>
<div class="outline-text-4" id="text-org150ce99">
<p>
built this wrong the first time, leading to a linker error when making bash.
</p>
</div>
</div>
<div id="outline-container-org03e0255" class="outline-4">
<h4 id="org03e0255">tar</h4>
<div class="outline-text-4" id="text-org03e0255">
<p>
tar being delivered in a tar ball is a special type of comedy.
</p>
</div>
</div>
</div>
<div id="outline-container-org3d2addb" class="outline-3">
<h3 id="org3d2addb">Chroot</h3>
<div class="outline-text-3" id="text-org3d2addb">
<p>
A lot of the setup in chroot chapter needs to be thoroughly re-re-read, mostly the associated standards.
</p>
</div>
<div id="outline-container-org0af1e4b" class="outline-4">
<h4 id="org0af1e4b">glibc</h4>
<div class="outline-text-4" id="text-org0af1e4b">
<p>
real <code>0m38.184s</code> tests <code>13m18.205s</code>
</p>
</div>
</div>
<div id="outline-container-org351edbe" class="outline-4">
<h4 id="org351edbe">gcc</h4>
<div class="outline-text-4" id="text-org351edbe">
<p>
real <code>3m28.512s</code> tests <code>14m58.613s</code>
</p>
</div>
</div>
<div id="outline-container-orga906b31" class="outline-4">
<h4 id="orga906b31">gettext</h4>
<div class="outline-text-4" id="text-orga906b31">
<p>
it was necessary to clear out the previous source folder for gettext and do a clean <code>tar -xvf gettext-...</code> for it to install properly.
</p>
</div>
</div>
<div id="outline-container-org049b066" class="outline-4">
<h4 id="org049b066">GDBM</h4>
<div class="outline-text-4" id="text-org049b066">
<p>
why don't we remove the static library <code>libgdbm_comat.la</code>?
</p>
</div>
</div>
<div id="outline-container-org5a2c084" class="outline-4">
<h4 id="org5a2c084">expat</h4>
<div class="outline-text-4" id="text-org5a2c084">
<p>
for some reason this tarball wasn't in the original list so i had to grab it.
</p>
</div>
</div>
<div id="outline-container-org0eec23b" class="outline-4">
<h4 id="org0eec23b">open-ssl</h4>
<div class="outline-text-4" id="text-org0eec23b">
<p>
an incredibly important package to keep an eye on for updates.
</p>
</div>
</div>
<div id="outline-container-orgc68e26f" class="outline-4">
<h4 id="orgc68e26f">coreutils</h4>
<div class="outline-text-4" id="text-orgc68e26f">
<p>
running into issue not finding <code>aclocal</code>. this was caused by somehow skipping <code>automake</code> :^)
</p>
</div>
</div>
<div id="outline-container-orgc3cb843" class="outline-4">
<h4 id="orgc3cb843">gawk</h4>
<div class="outline-text-4" id="text-orgc3cb843">
<p>
it was around this point that my 20GiB partition for root was no longer satisfactory, so i had to clean up some of the source files. the biggest gain was from taking out the <code>gcc</code> directory. from this point on i clean up the directories after installing.
</p>
</div>
</div>
<div id="outline-container-org1ffab4f" class="outline-4">
<h4 id="org1ffab4f">patch</h4>
<div class="outline-text-4" id="text-org1ffab4f">
<p>
first stumper: have an issue with <code>/lib/getopt-cdefs.h:32:5: error: #if with no expression</code> and i do not know why. a fresh tarball and <code>configure</code> seemed to have fixed the issue, though.
</p>
</div>
</div>
<div id="outline-container-org4d7a1e5" class="outline-4">
<h4 id="org4d7a1e5">tar</h4>
<div class="outline-text-4" id="text-org4d7a1e5">
<p>
testing tar i ran into space issues again. running <code>du -h . | sort -n -r | head - n 20</code> showed me that the linux kernel that was previously unpacked was taking up a lot of space, so i got rid of that along with a few other offenders.
</p>
</div>
</div>
<div id="outline-container-org1b603d1" class="outline-4">
<h4 id="org1b603d1">vim</h4>
<div class="outline-text-4" id="text-org1b603d1">
<p>
i did emacs instead :^)
</p>
</div>
</div>
<div id="outline-container-orga9150ec" class="outline-4">
<h4 id="orga9150ec">emacs</h4>
<div class="outline-text-4" id="text-orga9150ec">
</div>
<ul class="org-ul">
<li><a id="org9fba853"></a>nettle<br /></li>
<li><a id="org87df47a"></a>libtasn1<br /></li>
<li><a id="org21bf5fb"></a>libunistring<br /></li>
<li><a id="org17fa5b4"></a>p11-kit<br /></li>
<li><a id="org00a210e"></a>gnutools<br /></li>
</ul>
</div>
</div>
<div id="outline-container-org71c325c" class="outline-3">
<h3 id="org71c325c">kernel</h3>
<div class="outline-text-3" id="text-org71c325c">
<p>
i won't go into all the settings i did. building the kernel took real <code>1m8.923s</code>
</p>
</div>
</div>
<div id="outline-container-org76c161d" class="outline-3">
<h3 id="org76c161d">grub</h3>
<div class="outline-text-3" id="text-org76c161d">
<p>
rebooted, having some issues. UEFI doesn't see it as bootable (obviously) but my 'host' OS was just a live linux environment. the real host OS is windows, so it just boots straight into that.
</p>
</div>
</div>
</div>
<div id="outline-container-org9e76797" class="outline-2">
<h2 id="org9e76797"><span class="todo TODO">TODO</span> Recovering from a failed grub</h2>
<div class="outline-text-2" id="text-org9e76797">
<p>
first we have to re-mount the drives
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-builtin">export</span> LFS = /mnt/lfs
sudo mkdir -pv $<span class="org-variable-name">LFS</span>
sudo mount -v -t ext4 /dev/nvme1n1p4 $<span class="org-variable-name">LFS</span>
sudo mkdir -pv $<span class="org-variable-name">LFS</span>/home
sudo mount -v -t ext4 /dev/nvme1n1p5 $<span class="org-variable-name">LFS</span>/home
sudo /sbin/swapon -v /dev/nvme1n1p3
</pre>
</div>
<p>
we already have installed the kernel, but all the important things are mounted during the boot of our system. this means things like <code>devtmpfs</code> is not mounted to <code>/dev</code> right now.
</p>
<div class="org-src-container">
<pre class="src src-bash">sudo makedir -pv $<span class="org-variable-name">LFS</span>/{dev,proc,sys,run} <span class="org-comment-delimiter"># </span><span class="org-comment">just incase we didn't have it already</span>

sudo mount -v --bind /dev $<span class="org-variable-name">LFS</span>/dev
sudo mount -vt devpts devpts -o <span class="org-variable-name">gid</span>=5,<span class="org-variable-name">mode</span>=0620 $<span class="org-variable-name">LFS</span>/dev/pts
sudo mount -vt proc proc $<span class="org-variable-name">LFS</span>/proc
sudo mount -vt sysfs sysfs $<span class="org-variable-name">LFS</span>/sys
sudo mount -vt tmpfs tmpfs $<span class="org-variable-name">LFS</span>/run
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash">chroom $<span class="org-variable-name">LFS</span> /usr/bin/env -i <span class="org-sh-escaped-newline">\</span>
       <span class="org-variable-name">HOME</span>=/root           <span class="org-sh-escaped-newline">\</span>
       <span class="org-variable-name">TERM</span>=<span class="org-string">"$TERM"</span>         <span class="org-sh-escaped-newline">\</span>
       <span class="org-variable-name">PS1</span>=<span class="org-string">'(lfs chroot) \u:\w\$'</span> <span class="org-sh-escaped-newline">\</span>
       <span class="org-variable-name">PATH</span>=/usr/bin:/usr/sbin <span class="org-sh-escaped-newline">\</span>
       <span class="org-variable-name">MAKEFLAGS</span>=<span class="org-string">"-j24"</span>     <span class="org-sh-escaped-newline">\</span>
       <span class="org-variable-name">TESTSUITEFLAGS</span>=<span class="org-string">"-j24"</span> <span class="org-sh-escaped-newline">\</span>
       /bin/bash --login
</pre>
</div>
<p>
and we're back in. the first important thing to check is the linux kernel's <code>.config</code> to ensure it has all the UEFI flags turned on.
</p>
<div class="org-src-container">
<pre class="src src-bash">cat .config | grep -i efi.*=y$
</pre>
</div>
<p>
the following shows up:
</p>
<div class="org-src-container">
<pre class="src src-conf"><span class="org-variable-name">CONFIG_EFI</span>=y <span class="org-comment-delimiter">#</span>
<span class="org-variable-name">CONFIG_EFI_STUB</span>=y <span class="org-comment-delimiter">#</span>
<span class="org-variable-name">CONFIG_EFI_HANDOVER_PROTOCOL</span>=y
<span class="org-variable-name">CONFIG_EFI_MIXED</span>=y
<span class="org-variable-name">CONFIG_EFI_RUNTIME_MAP</span>=y
<span class="org-variable-name">CONFIG_PREFIX_SYMBOLS</span>=y
<span class="org-variable-name">CONFIG_EFI_PARTITION</span>=y <span class="org-comment-delimiter"># </span><span class="org-comment">this is our GPT support</span>
<span class="org-variable-name">CONFIG_DMI_SCAN_MACHINE_NON_EFI_FALLBACK</span>=y
<span class="org-variable-name">CONFIG_EFI_ESRT</span>=y
<span class="org-variable-name">CONFIG_EFI_DXE_MEM_ATTRIBUTES</span>=y
<span class="org-variable-name">CONFIG_EFI_RUNTIME_WRAPPERS</span>=y
<span class="org-variable-name">CONFIG_EFI_EARLYCON</span>=y
<span class="org-variable-name">CONFIG_EFI_CUSTOM_SSDT_OVERLAYS</span>=y
</pre>
</div>
<p>
we need kernel support for the <code>vfat</code> file system
</p>
<div class="org-src-container">
<pre class="src src-bash">cat .config | grep -i vfat.*=y$
</pre>
</div>
<div class="org-src-container">
<pre class="src src-conf"><span class="org-variable-name">CONFIG_VFAT_FS</span>=y
</pre>
</div>
<p>
we need to re-mount our <code>/boot/efi</code> and our <code>/boot</code>
</p>
<div class="org-src-container">
<pre class="src src-bash">mount -vt ext2 /dev/nvme1n1p2 /boot
mount --mkdir -v -t vfat /dev/nvme1n1p1 -o <span class="org-variable-name">codepage</span>=437,<span class="org-variable-name">iocharset</span>=iso8859-1 <span class="org-sh-escaped-newline">\</span>
      /boot/efi
</pre>
</div>
<p>
okay, all the mounting and organizing is done. now for the next part: building grub for efi. im going to try and skip having to build <code>efibootmgr</code> if at all possible, which means we will be hard pathing the boot loader.
</p>
<div class="org-src-container">
<pre class="src src-bash">make clean <span class="org-comment-delimiter"># </span><span class="org-comment">i dont want anything we did before interfering</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">TODO just copy the lines from the LFS documentation</span>
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.4 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</p>
</div>
</body>
</html>
